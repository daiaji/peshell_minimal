# .github/workflows/release.yml

name: Build and Release PEShell

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "要创建的标签和版本号 (例如: v1.0.1)"
        required: true
        type: string
      # ... 其他输入 ...

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      # ... [前面 Checkout, Setup MSVC, Cache LuaJIT 等步骤保持不变] ...
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        
      # ... (省略与 ci.yml 重复的缓存、LuaJIT安装、LuaRocks安装等步骤) ...

      - name: Get LuaJIT submodule commit hash
        id: luajit-hash
        run: |
          $submodule_hash = (git submodule status vendor/luajit2).Trim().Split(' ')[0]
          echo "hash=$submodule_hash" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Cache MSVC-built LuaJIT
        id: cache-luajit
        uses: actions/cache@v4
        with:
          path: .lua
          key: msvc-luajit-v2-${{ runner.os }}-${{ steps.luajit-hash.outputs.hash }}

      - name: Build and install LuaJIT if not cached
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        run: cmake --build build --config Release --target install_luajit

      - name: Add MSVC-built Lua to PATH
        run: echo "${{ github.workspace }}\.lua\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh
      
      - name: Setup LuaRocks
        uses: luarocks/gh-actions-luarocks@v6

      - name: Cache LuaRocks dependencies
        id: cache-luarocks
        uses: actions/cache@v4
        with:
          path: staging
          key: luarocks-deps-v1-${{ runner.os }}-${{ hashFiles('peshell-minimal-dev-1.rockspec') }}

      - name: Install Lua dependencies into staging directory
        if: steps.cache-luarocks.outputs.cache-hit != 'true'
        run: |
          luarocks config variables.LUA_LIBDIR ${{ github.workspace }}\.lua\lib
          luarocks install --tree=./staging peshell-minimal-dev-1.rockspec --only-deps

      - name: Configure CMake for main project
        run: cmake -S . -B build -G "Ninja"

      - name: Set Release Tag Variable
        id: vars
        run: |
          $tag = if ("${{ github.event_name }}" -eq "push") { "${{ github.ref_name }}" } else { "${{ inputs.tag_name }}" }
          echo "tag_name=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh
        
      - name: Assemble Final Release Package
        id: assemble
        run: |
          luarocks pack peshell-minimal-dev-1.rockspec
          $package_dir = New-Item -ItemType Directory -Path "${{ github.workspace }}/peshell-release" -Force
          luarocks install --tree=$package_dir peshell-minimal-dev-1.src.rock --deps-mode=all
          echo "package_path=$package_dir" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # [[ 核心新增步骤 ]]
      - name: Copy VC++ Redistributable DLLs
        run: |
          $vctools_redist_dir = $env:VCToolsRedistDir
          $package_bin_dir = "${{ steps.assemble.outputs.package_path }}/bin"
          
          Write-Host "Searching for VC++ Redistributable DLLs in: $vctools_redist_dir"
          
          Copy-Item -Path "$vctools_redist_dir/x64/Microsoft.VC14*.CRT/*" -Destination $package_bin_dir -Recurse -Force
          
          Write-Host "Successfully copied VC++ runtime DLLs."
        shell: pwsh

      - name: Print final package structure before zipping
        run: |
          cd ${{ steps.assemble.outputs.package_path }}
          tree /F .
        shell: cmd

      - name: Create Zip Archive
        id: package
        run: |
          $zipFileName = "peshell-${{ steps.vars.outputs.tag_name }}.zip"
          Compress-Archive -Path "${{ steps.assemble.outputs.package_path }}/*" -DestinationPath $zipFileName
          echo "zip_name=$zipFileName" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.package.outputs.zip_name }}
          tag_name: ${{ steps.vars.outputs.tag_name }}
          name: ${{ github.event.inputs.release_name || format('PEShell {0}', steps.vars.outputs.tag_name) }}
          body: ${{ github.event.inputs.body }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}