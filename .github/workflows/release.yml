name: Build and Release PEShell

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag (e.g., v1.0.1)"
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.lua
      LUAJIT_SRC_DIR: vendor/luajit/src

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Update Deps
        shell: pwsh
        run: .\update_vendor.ps1

      - name: Cache LuaJIT
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-md-${{ hashFiles('vendor/luajit/.git') }}

      - name: Build LuaJIT
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd %LUAJIT_SRC_DIR%
          call msvcbuild.bat gc64
          mkdir "%LUAJIT_BIN_DIR%\bin"
          mkdir "%LUAJIT_BIN_DIR%\lib"
          mkdir "%LUAJIT_BIN_DIR%\include"
          mkdir "%LUAJIT_BIN_DIR%\jit"
          
          copy lua51.dll "%LUAJIT_BIN_DIR%\bin\"
          copy luajit.exe "%LUAJIT_BIN_DIR%\bin\"
          copy lua51.lib "%LUAJIT_BIN_DIR%\lib\"
          
          copy lua.h "%LUAJIT_BIN_DIR%\include\"
          copy lualib.h "%LUAJIT_BIN_DIR%\include\"
          copy lauxlib.h "%LUAJIT_BIN_DIR%\include\"
          copy luaconf.h "%LUAJIT_BIN_DIR%\include\"
          copy luajit.h "%LUAJIT_BIN_DIR%\include\"
          copy lua.hpp "%LUAJIT_BIN_DIR%\include\"
          
          rem [新增]
          copy jit\*.lua "%LUAJIT_BIN_DIR%\jit\"

      - name: Build PEShell
        run: |
          cmake -S . -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Set Tag Variable
        id: vars
        shell: pwsh
        run: |
          $tag = if ("${{ github.event_name }}" -eq "push") { "${{ github.ref_name }}" } else { "${{ inputs.tag_name }}" }
          echo "tag_name=$tag" >> $env:GITHUB_OUTPUT

      - name: Assemble Package
        id: assemble
        shell: pwsh
        run: |
          $pkg = New-Item -ItemType Directory -Path "peshell-release" -Force
          $bin = New-Item -ItemType Directory -Path "$pkg/bin"
          $lua = New-Item -ItemType Directory -Path "$pkg/share/lua/5.1"
          $lib = New-Item -ItemType Directory -Path "$lua/lib"
          $jit = New-Item -ItemType Directory -Path "$lua/jit"

          Copy-Item "build/bin/peshell.exe" $bin
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\bin\lua51.dll" $bin
          Copy-Item "start_peshell_main.bat" $pkg

          Copy-Item "scripts/core", "scripts/plugins", "scripts/*.lua" $lua -Recurse
          
          # [新增] JIT Libs
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\jit\*.lua" $jit
          
          Copy-Item "vendor/lua-ext" "$lib/ext" -Recurse -Exclude .git,vendor
          Copy-Item "vendor/lua-ffi-bindings" "$lib/ffi" -Recurse -Exclude .git,vendor
          Copy-Item "vendor/proc_utils/proc_utils_ffi.lua" $lib
          Copy-Item "vendor/lfs/lfs_ffi.lua" $lib
          Copy-Item "vendor/luaunit/luaunit.lua" $lib

          $vctools = $env:VCToolsRedistDir
          Copy-Item "$vctools/x64/Microsoft.VC14*.CRT/*.dll" $bin -Force

          echo "package_path=$pkg" >> $env:GITHUB_OUTPUT

      - name: Create Zip Archive
        id: package
        shell: pwsh
        run: |
          $zipName = "peshell-${{ steps.vars.outputs.tag_name }}.zip"
          Compress-Archive -Path "${{ steps.assemble.outputs.package_path }}/*" -DestinationPath $zipName
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.package.outputs.zip_name }}
          tag_name: ${{ steps.vars.outputs.tag_name }}
          name: ${{ github.event.inputs.release_name || format('PEShell {0}', steps.vars.outputs.tag_name) }}
          draft: false
          prerelease: false