# 工作流名称
name: Build and Release PEShell

# 工作流触发条件
on:
  # 1. 自动触发：当推送 'v*.*.*' 格式的标签时
  push:
    tags:
      - "v*.*.*"
  
  # 2. 手动触发：允许在 Actions 页面手动运行此工作流
  workflow_dispatch:
    inputs:
      tag_name:
        description: '要创建的标签和版本号 (例如: v1.0.1)'
        required: true
        type: string
      release_name:
        description: '发布的标题 (可选, 默认为 "Release [tag_name]")'
        required: false
      body:
        description: '发布说明 (可选, 支持 Markdown)'
        required: false
      prerelease:
        description: '是否标记为预发布版本?'
        required: true
        type: boolean
        default: false

# 定义任务
jobs:
  build-and-release:
    # 指定运行环境为最新的 Windows
    runs-on: windows-latest
    
    # 为此任务授予创建 Release 所需的写入权限
    permissions:
      contents: write

    # 任务步骤
    steps:
      # 步骤1: 检出代码，并递归检出所有子模块
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 步骤2: 设置 MSVC 开发环境 (x64)
      - name: Setup MSVC environment
        uses: microsoft/setup-msbuild@v1.3
        with:
          vs-architecture: 'x64'
      
      # 步骤3: 定义版本标签变量
      - name: Set Release Tag Variable
        id: vars
        run: |
          # 如果是推送标签触发的，使用 github.ref_name；如果是手动触发，使用 inputs.tag_name
          $tag = if ("${{ github.event_name }}" -eq "push") { "${{ github.ref_name }}" } else { "${{ inputs.tag_name }}" }
          echo "tag_name=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # 步骤4: 配置 CMake
      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      # 步骤5: 编译项目 (Release 模式)
      - name: Build Project
        run: cmake --build build --config Release

      # 步骤6: 准备发布包
      - name: Prepare Release Package
        run: |
          # 创建一个临时目录用于打包
          mkdir release_package
          # 拷贝编译好的可执行文件
          copy "build\Release\peshell.exe" "release_package\"
          # 递归拷贝整个 scripts 目录
          xcopy "scripts" "release_package\scripts\" /E /I /Y
        shell: cmd
      
      # 步骤7: 创建 Zip 压缩包
      - name: Create Zip Archive
        id: package
        run: |
          $zipFileName = "peshell-${{ steps.vars.outputs.tag_name }}.zip"
          Compress-Archive -Path "release_package\*" -DestinationPath $zipFileName
          echo "zip_name=$zipFileName" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # 步骤8: 创建 GitHub Release 并上传压缩包
      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v1
        with:
          # 要上传的文件
          files: ${{ steps.package.outputs.zip_name }}
          # 发布的标签名
          tag_name: ${{ steps.vars.outputs.tag_name }}
          # 发布的标题
          name: ${{ github.event.inputs.release_name || format('PEShell {0}', steps.vars.outputs.tag_name) }}
          # 发布说明
          body: ${{ github.event.inputs.body }}
          # 是否为草稿
          draft: false
          # 是否为预发布
          prerelease: ${{ github.event.inputs.prerelease }}