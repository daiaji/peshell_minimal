name: CI Build and Package

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    env:
      LUAJIT_BIN_DIR: ${{ github.workspace }}\.lua
      LUAJIT_SRC_DIR: vendor/luajit/src

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Update Deps
        shell: pwsh
        run: .\update_vendor.ps1

      - name: Cache LuaJIT
        id: cache-luajit
        uses: actions/cache@v3
        with:
          path: ${{ env.LUAJIT_BIN_DIR }}
          key: ${{ runner.os }}-luajit-md-${{ hashFiles('vendor/luajit/.git') }}

      - name: Build LuaJIT (Dynamic CRT)
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          cd %LUAJIT_SRC_DIR%
          call msvcbuild.bat gc64
          
          mkdir "%LUAJIT_BIN_DIR%\bin"
          mkdir "%LUAJIT_BIN_DIR%\lib"
          mkdir "%LUAJIT_BIN_DIR%\include"
          mkdir "%LUAJIT_BIN_DIR%\jit"
          
          copy lua51.dll "%LUAJIT_BIN_DIR%\bin\"
          copy luajit.exe "%LUAJIT_BIN_DIR%\bin\"
          copy lua51.lib "%LUAJIT_BIN_DIR%\lib\"
          
          rem 复制头文件
          copy lua.h "%LUAJIT_BIN_DIR%\include\"
          copy lualib.h "%LUAJIT_BIN_DIR%\include\"
          copy lauxlib.h "%LUAJIT_BIN_DIR%\include\"
          copy luaconf.h "%LUAJIT_BIN_DIR%\include\"
          copy luajit.h "%LUAJIT_BIN_DIR%\include\"
          copy lua.hpp "%LUAJIT_BIN_DIR%\include\"
          
          rem [新增] 复制 JIT 库文件 (vmdef.lua, bc.lua 等)
          copy jit\*.lua "%LUAJIT_BIN_DIR%\jit\"

      - name: Disable Windows Defender
        shell: pwsh
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableIOAVProtection $true
          Set-MpPreference -DisableArchiveScanning $true
          Write-Host "Windows Defender Real-time Monitoring disabled."

      - name: Build PEShell
        run: |
          cmake -S . -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release

      - name: Assemble Package
        shell: pwsh
        run: |
          $pkg = New-Item -ItemType Directory -Path "package" -Force
          $bin = New-Item -ItemType Directory -Path "$pkg/bin"
          $lua = New-Item -ItemType Directory -Path "$pkg/share/lua/5.1"
          $lib = New-Item -ItemType Directory -Path "$lua/lib"
          # [新增] JIT 库目录
          $jit = New-Item -ItemType Directory -Path "$lua/jit"

          # A. 二进制
          Copy-Item "build/bin/peshell.exe" $bin
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\bin\lua51.dll" $bin
          Copy-Item "start_peshell_main.bat" $pkg

          # B. 脚本
          Copy-Item "scripts/core", "scripts/plugins", "scripts/*.lua" $lua -Recurse
          
          # C. JIT 库 (放在 share/lua/5.1/jit)
          Copy-Item "${{ env.LUAJIT_BIN_DIR }}\jit\*.lua" $jit

          # D. 纯 Lua 依赖库
          Copy-Item "vendor/lua-ext" "$lib/ext" -Recurse -Exclude .git,vendor
          Copy-Item "vendor/lua-ffi-bindings" "$lib/ffi" -Recurse -Exclude .git,vendor
          Copy-Item "vendor/proc_utils/proc_utils_ffi.lua" $lib
          Copy-Item "vendor/lfs/lfs_ffi.lua" $lib
          Copy-Item "vendor/luaunit/luaunit.lua" $lib

          # E. VC++ Runtime
          $vctools = $env:VCToolsRedistDir
          $crt = Join-Path $vctools "x64/Microsoft.VC14*.CRT"
          Write-Host "Copying CRT from $crt"
          Copy-Item "$crt/*.dll" $bin -Force

          echo "PACKAGE_PATH=$pkg" >> $env:GITHUB_ENV

      - name: Smoke Test
        working-directory: ${{ env.PACKAGE_PATH }}
        run: |
          .\bin\peshell.exe run share\lua\5.1\test_suite.lua

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: peshell-release
          path: ${{ env.PACKAGE_PATH }}