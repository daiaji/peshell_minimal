# ================================================================= #
#     GitHub Actions CI Workflow for peshell_minimal Project      #
# ================================================================= #

name: PEShell Minimal CI (Release Build)

# 触发条件：
# 1. 当代码推送到 main 或 master 分支时
# 2. 当有 Pull Request 指向 main 或 master 分支时
# 3. 允许在 GitHub Actions 页面手动触发 (workflow_dispatch)
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  # 定义一个名为 'build-windows-release' 的任务
  build-windows-release:
    # 指定此任务在最新的 Windows runner 上运行
    runs-on: windows-latest

    # 任务执行步骤
    steps:
      # 步骤 1: 检出代码
      # 使用 actions/checkout@v4，这是标准操作
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          # 关键：'recursive' 选项会检出 .gitmodules 中定义的所有子模块
          submodules: 'recursive'

      # 步骤 2: 设置 MSVC 开发环境
      # 使用 microsoft/setup-msbuild@v1.3 来配置 Visual Studio 2022 的环境
      - name: Setup MSVC environment
        uses: microsoft/setup-msbuild@v1.3
        with:
          # 指定使用 x64 架构的工具链
          vs-architecture: 'x64'

      # 步骤 3: 配置 CMake
      # -S .: 源码树的根目录是当前目录
      # -B build: 构建树的根目录是 'build' 子目录
      # -G "..." -A x64: 指定使用 VS 2022 的 64 位生成器
      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      # 步骤 4: 编译项目
      # --build build: 指定要构建的目录
      # --config Release: 明确指定构建 Release 配置
      - name: Build Project
        run: cmake --build build --config Release

      # 步骤 5: 打包构建产物以便上传
      - name: Package Release Artifacts
        run: |
          # 创建一个临时目录用于存放要打包的文件
          mkdir artifact
          # 拷贝编译出的可执行文件
          copy "build\Release\peshell.exe" "artifact\"
          # 递归拷贝整个 scripts 目录
          xcopy "scripts" "artifact\scripts\" /E /I /Y
        shell: cmd

      # 步骤 6: 上传构建产物
      # 使用 actions/upload-artifact@v4 将打包好的文件上传
      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          # 上传的产物名称，在 Actions 页面会显示这个名字
          name: peshell-release-build
          # 要上传的目录路径
          path: artifact/